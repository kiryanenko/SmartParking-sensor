Система мониторинга парковочных мест
====================================
МК-подсистема регистрации свободных парковочных мест
----------------------------------------------------

### АННОТАЦИЯ

Дипломный проект посвящен разработке системы мониторинга парковочных
мест. При выполнении дипломного проекта, было проведено исследование IoT
технологий в сфере транспортной инфраструктуры. В рамках исследования
был проведен анализ существующих систем. На основании этого был
спроектирован недорогой относительно конкурентов аппаратно-программный
прототип системы мониторинга парковочных мест. Основное назначение
системы заключается в определении наличия свободных парковочных мест и
отображении этих данных пользователям. Данная система позволит
пользователям (водителям) в режиме реального времени получать актуальную
информацию о состоянии парковочных мест.

### ABSTRACT

The diploma project is devoted to the development of a monitoring system
for parking places. When carrying out the diploma project, was conducted
research IoT technologies in the field of transport infrastructure. As
part of the research, existing systems were analyzed. Based on this, the
hardware-software prototype of a monitoring system for parking places
was designed inexpensive with respect to competitors. The main purpose
of the system is to determine the availability of parking spaces and
display data for users. This system allows users (drivers) to receive
up-to-date information about status of parking places in real time.

РЕФЕРАТ
-------

Разработан проект «Система мониторинга парковочных мест». Основное
назначение системы заключается в определении наличия свободных
парковочных мест и отображении этих данных пользователям. Данная система
позволит пользователям (водителям) в режиме реального времени получать
актуальную информацию о состоянии парковочных мест. Данная система
состоит из: «МК-подсистемы регистрации свободных парковочных мест»,
вычислительного хаба и сервера.

«МК-подсистема регистрации свободных парковочных мест» фиксирует наличие
свободных парковочных мест. К микроконтроллеру подключаются сенсоры,
каждый из которых следит за своим парковочным местом. Через радиомодуль
RFM95W информация о состоянии парковочных мест (свободно / занято)
передается в вычислительный хаб, для последующей обработки. Реализована
функция оплаты парковочного места, с отображением на дисплее и
подтверждением оплаты с клавиатуры.

Основное назначение вычислительного хаба, состоит в осуществлении
взаимодействия сервера, датчиков «МК-подсистема регистрации свободных
парковочных мест» и других компонентов системы.

Сервер осуществляет сбор данных с датчиков «МК-подсистема регистрации
свободных парковочных», управление всеми компонентами системы и вывод
данных пользователям об актуальном состоянии парковочных мест

Материалы по дипломному проекту представлены в виде графической части,
приложения с отлаженным программным кодом и расчетно-пояснительной
записки.

ОПРЕДЕЛЕНИЯ, ОБОЗНАЧЕНИЯ И СОКРАЩЕНИЯ
-------------------------------------

- БС - беспроводная сеть
- БД - база данных
- МК - микроконтроллер
- МКПМ - модуль контроля парковочного места
- МКПРСПМ - МК-подсистема регистрации свободных парковочных мест
- ОС - операционная система
- ПМ - парковочное место
- ПО - программное обеспечение
- СМПМ - система мониторинга парковочных мест
- СУБД - система управления базами данных
- ТС - транспортное средство
- УГО - условно графическое обозначение.
- EEPROM - энергонезависимая перезаписываемая память
- IoT - internet of things
- LoRa - Long Range, метод модуляции в беспроводных сетях
- MQTT - message queue telemetry transport


СОДЕРЖАНИЕ
----------

[ВВЕДЕНИЕ](#ВВЕДЕНИЕ)

[Анализ требований к СМПМ](#Анализ-требований-к-СМПМ)

[Разработка диаграммы вариантов использований](#Разработка-диаграммы-вариантов-использований)

[Описание и структура СМПМ](#Описание-и-структура-СМПМ)

[Описание функциональной схемы СМПМ](#Описание-функциональной-схемы-СМПМ)

[Разработка МКПРСПМ](#Разработка-МКПРСПМ)

[Анализ требований к разрабатываемому устройству](#Анализ-требований-к-разрабатываемому-устройству)

[Разработка структурной схемы МКПРСПМ](#Разработка-структурной-схемы-МКПРСПМ)

[Разработка функциональной схемы МКПМ](#Разработка-функциональной-схемы-МКПМ)

[Разработка функциональной схемы МКПРСПМ](#Разработка-функциональной-схемы-МКПРСПМ)

[Разработка принципиальной схемы](#Разработка-принципиальной-схемы)

[Выбор элементной базы](#Выбор-элементной-базы)

[Микроконтроллер ATMEGA328](#Микроконтроллер-atmega328)

[Радиочастотный приёмопередатчика RFM95W](#Радиочастотный-приёмопередатчика-rfm95w)

[Расширитель портов PCF8574](#Расширитель-портов-pcf8574)

[Сравнение сенсоров присутствия автомобиля](#Сравнение-сенсоров-присутствия-автомобиля)

[Ультразвуковой датчик расстояния HC-SR04](#Ультразвуковой-датчик-расстояния-hc-sr04)

[Часы реального времени DS3231SN](#Часы-реального-времени-ds3231sn)

[Описание принципиальной схемы МКПМ](#Описание-принципиальной-схемы-МКПМ)

[Описание принципиальной схемы МКПРСПМ](#Описание-принципиальной-схемы-МКПРСПМ)

[Расчет потребляемой мощности](#Расчет-потребляемой-мощности)

[Описание разработанного программного обеспечения](#Описание-разработанного-программного-обеспечения)

[Описание схемы алгоритма](#Описание-схемы-алгоритма)

[Описание диаграммы классов](#Описание-диаграммы-классов)

[Описание системы сообщений МКПРСПМ](#Описание-системы-сообщений-МКПРСПМ)

[Тестирование СМПМ](#Тестирование-СМПМ)

[ЗАКЛЮЧЕНИЕ](#ЗАКЛЮЧЕНИЕ)

[Приложение В. Тестирование](/docs/Приложение%20В.%20Тестирование%20СMПМ.pdf)

[Приложение Е. Графическая документация](/docs/Приложение%20Е.%20Графическая%20документация.pdf)



ВВЕДЕНИЕ
--------

Дипломный проект «Система мониторинга парковочных мест» выполняется на
основании учебного плана кафедры ИУ6 с исходными данными, заданными в
техническом задании. Целью работы является проектирование системы
мониторинга парковочных мест.

Формирование специализированных зон для стоянки автотранспорта началось
почти одновременно с появлением первых автомобилей. Число машин
стремительно растет и для решения возникнувшей проблемы ограниченности
парковочных мест начали внедрять современные технологии.

Основным направлением развития являются «умные» датчики парковки. Такие
датчики встраиваются в дорожное полотно на места парковок и отслеживают
свободно ли машиноместо над ними, отдавая данные в общую систему.
Используя сеть таких датчиков, формируется карта парковок, состояния
которых рассылается пользователям на улицах с помощью специальных табло
или мобильного приложения.

Такая система позволяет решить следующие задачи:
-   сокращение очередей и времени поиска свободного места на парковке;
-   организация оптимального движения транспортных средств и пешеходов
    на парковке;
-   визуальное оповещение о количестве свободных мест в реальном времени
    с помощью информационных табло или на веб-портале;
-   оптимизация работы парковочного пространства.

В ходе данной работы была спроектирована «Система мониторинга
парковочных мест». Основное назначение системы заключается в определении
наличия свободных парковочных мест и отображении этих данных
пользователям. Данная система позволит пользователям (водителям) в
режиме реального времени получать актуальную информацию о состоянии
парковочных мест. Данная система состоит из: «МК-подсистемы регистрации
свободных парковочных мест», вычислительного хаба и сервера.


Анализ требований к СМПМ
========================

Разработка диаграммы вариантов использований
--------------------------------------------

Основное назначение СМПМ заключается в определении наличия свободных
парковочных мест и отображении этих данных пользователям. Данная система
позволяет пользователям (водителям) в режиме реального времени получать
актуальную информацию о состоянии парковочных мест.

Для уточнения требований к функционированию системы необходимо
определить варианты её использования при помощи диаграммы вариантов
использования. Система взаимодействует с двумя видами действующих лиц:
пользователь (водитель) и владелец стоянки. Соответствующие диаграммы
для этих лиц показаны на рисунках 5 и 6.

![Диаграмма вариантов использований для пользователя](/docs/Diagram_of_usage_options_for_the_user.svg)

Рисунок 5 - Диаграмма вариантов использований для пользователя

![Диаграмма вариантов использований для владельца стоянки](/docs/Diagram_of_usage_options_for_the_owner.svg)

Рисунок 6 - Диаграмма вариантов использований для владельца стоянки

Описание и структура СМПМ
-------------------------

На рисунке 7 представлена структурная схема системы мониторинга
парковочных мест. Система мониторинга парковочных мест состоит из
следующих блоков:
-   МК-подсистема регистрирования свободных парковочных мест (МКПРСПМ),
-   вычислительный хаб,
-   сервер.

Датчики МКПРСПМ служат для фиксации наличия свободных парковочных мест и
оплаты. МКПРСПМ формирует пакеты с информацией о свободных парковочных
местах и передаёт их на вычислительный хаб по беспроводной сети LoRaWAN.

Вычислительный хаб, представленный в виде микрокомпьютера Raspberry Pi,
необходим для осуществления взаимодействия сервера, МКПРСПМ и других
компонентов системы. Хаб выполняет приём пакетов, переданных с МКПРСПМ,
формирует пакеты MQTT и передает их на сервер по сети интернет. Обратно
от сервера хаб получает команды управления МКПРСПМ, которые также
передаются по сети LoRaWAN, на МК-подсистемы.

Пользователь с мобильного устройства на платформе Android с
установленным приложением сможет посмотреть карту с указанием
местоположений свободных парковочных мест. Мобильное приложение получает
данные о парковочных местах с помощью API-сервисов, предоставляемых
сервером.

![Структурная схема системы мониторинга парковочных мест](/docs/Structural_scheme.svg)

Рисунок 7 - Структурная схема системы мониторинга парковочных мест

Веб-клиент, предоставляет карту со свободными парковочными местами.
Также для владельцев стоянок, предоставляется возможность для управления
за парковочными местами: изменение тарифного плана, настройка параметров
МКПСРСПМ.

Описание функциональной схемы СМПМ
----------------------------------

На рисунке Рисунок 8 показана функциональная схема СМПМ. Система
работает следующим образом. В МКПРСПМ сигнал о состоянии парковочного
места приходит от сенсора присутствия автомобиля, после чего МК
ATMEGA328 формирует пакеты и отправляет их через радиомодуль RFM95 по
сети LoRaWAN на вычислительный хаб. Также по сети LoRaWAN МКРСППМ может
принять команды для изменения настроечных параметров.

Вычислительный хаб служит для осуществления взаимодействия сервера,
МКПРСПМ и других компонентов системы. Хаб через радиомодуль RFM95
принимает пакеты, переданные с МКПРСПМ, формирует MQTT пакеты и передает
их на сервер и на другие компоненты системы. Данные внутри MQTT пакетов
передаются в формате JSON. Обратно от сервера хаб получает команды
управления МКПРСПМ, которые также передаются по сети LoRaWAN, на
МК-подсистемы. ПО для вычислительного хаба написано с использованием
фреймворка Qt. На вычислительном хабе может быть установлено серверное
ПО, тем самым хаб сформирует локальную сеть, внутри которой сможет
работать как сервер. MQTT - это легкий протокол для передачи данных,
который идеально подходит для взаимодействия большого количества IoT
устройств. Таким образом, к вычислительному хабу возможно подключить
множество других устройств (например, табло индикации количества
свободных парковочных мест), позволяющие взаимодействовать по протоколу
MQTT.

![Функциональная схема СМПМ](/docs/Functional_diagram.svg)

Рисунок 8 - Функциональная схема СМПМ

Сервер взаимодействует с вычислительным хабом по протоколу MQTT. Для
этого на сервере установлен MQTT брокер Mosquitto. Приложение на
фреймворке Ruby on Rails принимает данные о состоянии ПМ через MQTT
брокер и сохраняет в БД PostgreSQL. Также сервер может управлять
датчиками МКПРСПМ, отправляя команды по протоколу MQTT на вычислительный
хаб. Сервер Nginx является Frontend сервером, он осуществляет раздачу
статики и проксирование запросов на веб-сервер Puma, который уже
взаимодействует с веб-приложением на Ruby on Rails. Веб-приложение для
кэширования использует сервис кэширования Memcached. Для работы Action
Cable, который осуществляет взаимодействие с веб-клиентами по WebSocket,
необходима «key - value» хранилище данных Redis. Чтобы веб-клиент в
режиме реального времени получал данные о состоянии парковочных мест,
данные о парковочных местах в формате JSON периодически отправляются по
протоколу WebSocket.



Разработка МКПРСПМ
==================

Анализ требований к разрабатываемому устройству
-----------------------------------------------

Согласно техническому заданию, необходимо разработать МК-подсистему
регистрации свободных парковочных мест, выполненный на основе
микроконтроллера ATMEGA328. Данный регистратор фиксирует наличие
свободных парковочных мест. К микроконтроллеру подключаются сенсоры,
каждый из которых следит за своим парковочным местом. Через радиомодуль
информация о состоянии парковочных мест (свободно / занято) передается в
вычислительный хаб Raspberry Pi для последующей обработки. Должна быть
реализована функция оплаты парковочного места.

Проанализировав задание, можно заключить, что разрабатываемая система
должна представлять собой аппаратно-программный модуль, содержащий
непосредственно микроконтроллер ATMEGA328, запрограммированный
исполняющей программой. К микроконтроллеру через расширители портов
PCF8574 подключаются сенсоры, следящие за парковочными местами. Также,
расширитель портов PCF8574 используется для вывода информации о
состоянии закрепленного за ним парковочного места. Для коммуникации с
вычислительным хабом Raspberry Pi используется радиомодуль LoRa. Для
реализации функции оплаты парковочного места используется терминал
оплаты, состоящий из дисплея и клавиатуры. Работа с терминалом построена
в диалоговом режиме.

Разработка структурной схемы МКПРСПМ
------------------------------------

МКПРСПМ служит для фиксации наличия свободных парковочных мест и оплаты.
Данная подсистема состоит из следующих элементов (Рисунок 9):
-   микроконтроллер ATMEGA328,
-   модули контроля парковочного места (МКПМ),
-   терминал оплаты,
-   радиомодуль RFM95W.
-   Часы реального времени DS3231

Каждое парковочное место оборудовано МКПМ, состоящем из сенсора, который
определяет свободно ли парковочное место, и расширителем портов PCF8574,
для подсоединения сенсора к МК. Выводами «Free» и «Booked» служат для
отображения информации о текущем состоянии данного парковочного места.
Логическая «1» на выводе «Free» означает, что данное парковочное место
свободно, а «0» - занято. Логическая «1» на выводе «Booked» означает,
что данное место забронировано, а «0» - нет.

![Структурная.png](/docs/media/image9.png)

Рисунок 9 - Структурная схема МКПРСПМ

Микроконтроллер ATMEGA328 с помощью модулей МКПМ считывает информацию о
состоянии парковочных мест и устанавливает на индикаторах МКПМ
соответствующие состояния. Далее микроконтроллер формирует пакеты с
информацией о свободных парковочных местах для передачи на
вычислительный хаб по беспроводной сети LoRaWAN.

Радиомодуль LoRa осуществляет приём / передачу данных по сети LoRaWAN.
Данный модуль подключён к МК по шине SPI.

Терминал оплаты осуществляет оплату парковочного места по заданному
тарифу. Он состоит из дисплея, для отображения информации для
пользователя, клавиатуры для ввода данных и расширителем портов PCF8574
для соединения клавиатуры с МК по шине I2C.

Часы реального времени DS3231 необходимы для постоянного учёта
хронометрических данных (дата, время) на микроконтроллере. Это позволяет
изменять тариф для оплаты парковочного места в зависимости от времени
суток. А также позволяет отображать текущее время на дисплее. Установка
заданного времени на часах происходит при приходе соответствующего
сообщения «Изменить время» (Описание системы сообщений МКПРСПМ).


Разработка функциональной схемы МКПМ
------------------------------------

Каждое парковочное место оборудованы МКПМ, который определяет свободно
ли данное парковочное место и выводит информацию о состоянии этого
парковочного места.

Была разработана функциональная схема МКПМ, представленная на рисунке Е.5. 
Данная схема описывает функциональный блок «PPCM» (Рисунок 10),
который используется при построении функциональной схемы МКПРСПМ.

![УГО функционального блока PPCM](/docs/media/image10.png)

Рисунок 10 - УГО функционального блока PPCM

Ниже на рисунке Рисунок 11, показана функциональная схема МКПМ.

![УГО функционального блока PPCM](/docs/media/image11.png)

Рисунок 11 - Функциональная схема МКПМ

Схема состоит из двух блоков:
-   Сенсор, который определяет свободно ли данное парковочное место.
-   Расширитель портов PCF8574, осуществляющий связь сенсора с МК, а
    также через выводы P1 и P2 выводит информацию о состоянии
    парковочного места. Расширитель подключен к МК по шине I2C. К выводу
    P0 подключается сенсор. Выход P1 выводит сигнал «Free», логическая
    «1» которого означает, что данное парковочное место свободно, а «0» - занято. 
    Выход P2 выводит сигнал «Booked», логическая «1» которого
    означает, что данное парковочное место забронировано, а «0» - нет.

    
Разработка функциональной схемы МКПРСПМ
---------------------------------------

Исходя из результатов анализа требований, можно выделить следующие функциональные блоки МКПРСПМ:
-   микроконтроллер ATMEGA328;
-   радиомодуль LoRa BEE;
-   USB-UART драйвер ATMEGA16U2
-   модулей МКПМ (PPCM) в количестве до 15 штук, устанавливаемых на каждое парковочное место;
-   клавиатура;
-   расширитель портов PCF8574 для подключения клавиатуры к микроконтроллеру;
-   дисплей;
-   часы реального времени DS3231.

В результате проведенного анализа, была спроектирована функциональная
схема взаимодействия элементов, приведенная на рисунке Е.6.

![Функциональная схема МКПРСПМ](/docs/Приложение%20Е.6.%20Функциональная%20схема%20МКПРСПМ.jpg)

Разберем структуру взаимодействия элементов на функциональной схеме. На
каждое парковочное место устанавливается МКПМ. Микроконтроллер ATMEGA328
с помощью модулей МКПМ, подключенных к МК по шине I2C, считывает
информацию о состоянии парковочных мест. После обработки данных,
микроконтроллер изменяет состояние парковочного места (свободно /
занято), установив выводы МКПМ в соответствующие состояния. Далее,
микроконтроллер формирует пакет с информацией о состоянии парковочного
места и отправляет его через шину SPI на радиомодуль LoRa BEE, который,
в последствии, передаёт на вычислительный хаб Raspberry Pi, для
последующей обработки.

Для осуществления оплаты заданного парковочного места используется
терминал оплаты, состоящий из дисплея, матричной клавиатуры и
расширителя портов PCF8574 для соединения клавиатуры с МК по шине I2C.
Дисплей подключается к МК по шине I2C. В диалоговом режиме на нём
отображается информация о текущем состоянии оплаты. МК через расширитель
портов опрашивает клавиатуру и определяет нажатые клавиши. Для опроса
клавиатуры подаются на выходы расширителя, подключенные к столбцам
клавиатуры, сканирующие импульсы, а на входах, подключенных к строкам,
определяется, какая клавиша из соответствующего столбца нажата. Далее МК
соответствующе обрабатывает нажатые клавиши и отображает результат
обработки на дисплей.

Разработка принципиальной схемы
-------------------------------

### Выбор элементной базы

#### Микроконтроллер ATMEGA328

В данной работе решено было использовать микроконтроллер семейства AVR,
так как он: широко распространен, имеет развитую систему команд,
удовлетворяет всем современным технологическим требованиям. Данное
семейство восьмиразрядных микроконтроллеров имеет обширное количество
различных моделей. Было решено использовать ATMEGA328 как широко
распространенный и недорогой микроконтроллер, позволяющий реализовать
все поставленные задачи. УГО данного МК показано на рисунке Рисунок 12.

![](/docs/media/image12.png)

Рисунок 12 - УГО ATMEGA328

Описание выводов микроконтроллера приведено в таблице 1.

Таблица 1 - Описание выводов МК ATMEGA328

| № вывода              | Мнемоника             | Назначение вывода                                                          |
|-----------------------|-----------------------|----------------------------------------------------------------------------|
| 7                     | VCC                   | Питание +5В                                                                |
| 8                     | GND                   | Земля                                                                      |
| 17                    | MOSI                  | Вход ведомого. Служит для передачи данных от ведущего устройства ведомому  |
| 18                    | MISO                  | Выход ведомого. Служит для передачи данных от ведомого устройства ведущему |
| 19                    | SCK                   | Последовательный тактовый сигнал                                           |
| 3-6, 11-19            | PD1-PD6, PB0-PB5      | Цифровые входы/выходы                                                      |
| 23-28                 | PC0-PC5               | Аналоговые входы/выходы                                                    |
| 1                     | PC6                   | Перезапуск МК                                                              |
| 2                     | PD0                   | Чтение (разъем для программатора)                                          |
| 9                     | PB6                   | Подключение внешнего резонатора (вход)                                     |
| 10                    | PB7                   | Подключение внешнего резонатора (выход)                                    |


Микроконтроллер ATMEGA328 обладает следующими особенностями и
техническими характеристиками:
1.  расширенная архитектура RISC:
    -   мощная система команд со 131 инструкцией, большинство из которых выполняются за один машинный цикл,
    -   32 восьмиразрядных регистра общего назначения,
    -   производительность до 20 млн. оп./с на частоте 20МГц,
    -   встроенное умножение за 2 цикла;
2.  высокая износостойкость энергонезависимых сегментов памяти:
    -   32 КБ встроенной самопрограммируемой flash-памяти,
    -   1 КБ энергонезависимой памяти (EEPROM),
    -   2 КБ статической памяти (SRAM),
    -   10000/100000 циклов перезаписи для Flash/EEPROM,
    -   хранение данных в течение 20 лет при температуре 25${^\circ}$С,
3.  системы ввода-вывода: 23 программируемые линии ввода-вывода;
4.  рабочее напряжение: от 1.8 до 5.5 В;
5.  рабочая температура: от -40${^\circ}$ до 85${^\circ}$ С;
6.  рабочая частота (4.5 - 5.5В): 20 МГц;
7.  энергопотребление (1МГц, 1.8 В, 25${^\circ}$ С):
    -   активный режим: 0.2 мА,
    -   режим пониженного энергопотребления: 0.1 мкА.

#### Радиочастотный приёмопередатчика RFM95W

RFM95W - модуль радиочастотного приёмопередатчика, работающий на
частоте 868/915 МГц Работа приёмопередатчика основана на технологии
LoRa, которая позволяет добиться широкополосной передачи данных при
крайне низком энергопотреблении, а также высокой помехоустойчивости. 
Описание выводов RFM95W представлено в таблице 3.

Таблица 3 - Описание выводов RFM95W

  № Вывода                | Мнемоника                            | Описание
  ----------------------- | ------------------------------------ | --------------------------------------------
  1, 8, 10                | GND                                  | Земля
  2                       | MISO                                 | SPI выход последовательной передачи данных
  3                       | MOSI                                 | SPI вход последовательного приема данных
  4                       | SCK                                  | SPI вход синхронизации приема данных
  5                       | NSS                                  | SPI вход выбора подчиненного
  6                       | RESET                                | Вход сброса
  7, 11, 12, 14, 15, 16   | DIO5, DIO3, DIO4, DIO0, DIO1, DIO2   | Цифровой вход / выход конфигурации
  9                       | ANT                                  | Вход / выход на антенну
  13                      | 3,3V                                 | Питание 3,3В

**Технические характеристики:**
-   Максимальный размер канала связи 168 дБ.
-   Режим повышенной мощности, +20дБм/100мВт.
-   Стандартный режим +14 дБм.
-   Программируемая скорость передачи данных до 300 кбит / с.
-   Высокая чувствительность: до -148 дБм.
-   Низкий ток потребления пи приёме 10,3 мА.
-   Полностью интегрированный синтезатор с разрешением 61 Гц.
-   FSK, GFSK, MSK, GMSK, LoRaTM и OOK модуляции.
-   127 дБ динамический диапазон RSSI.
-   Пакетный движок до 256 байтов с CRC.
-   Встроенный датчик температуры и индикатор разряда батареи.
-   Размер модуля: 16x16 мм

#### Расширитель портов PCF8574

PCF8574 - кремневая ИС, выполненная по CMOS-технологии.
Посредством двухлинейной двунаправленной шины I2C она обеспечивает
дистанционное расширение порта ввода - вывода общего назначения в
большинстве серий микроконтроллеров. Устройство состоит из 8-битного
квазипорта ввода-вывода и интерфейса I2C-шины. PCF8574 имеет низкий
потребляемый ток. В устройстве установлена линия прерывания (INT),
которая может быть подключена к логике прерывания микроконтроллера.
Посылая сигнал прерывания по этой линии, дистанционный ввод - вывод
сообщает микроконтроллеру о поступающих на его порты данных, без
необходимости поддерживать связь через I2C-шину. Это значит, что PCF8574
может оставаться простым \"подчиненным\" устройством. На рисунке 14 приведено УГО модификаций PCF8574P и PCF8574AP.

![](/docs/media/image14.png)

Рисунок 14 - УГО расширителя портов PCF8574P и PCF8574AP

В таблице 4 приведено описание выводов PCF8574.

Таблица 4 - Описание выводов PCF8574P / PCF8574AP

  № Вывода          | Мнемоника            | Описание
  ----------------- | -------------------- | --------------------------------------
  1 - 3             | A0 - A2              | Адресные входы
  4 - 7, 9 - 12     | P0 - P3, P4 - P7     | Квази-двунаправленный ввод / вывод
  8                 | Vss                  | Земля
  13                | INT                  | Вывод прерывания
  14                | SCL                  | Последовательная линия синхронизации
  15                | SDA                  | Последовательная линия данных
  16                | Vdd                  | Питание 5 В

У данной микросхемы PCF8574 можно задавать адрес, под которым она будет
обозначаться на шине I2C. Всего имеется 8 вариантов адресации т.е. можно
подключить 8 модулей, что в сумме позволяет нарастить 64 входа/выхода,
используя 2 вывода контроллера. Для изменения адресации необходимо
установить на выводах A0, A1, A2 потенциал, соответствующий логическому «0» или «1».

Модификация PCF8574AP отличается от PCF8574P только базовым адресом: у
PCF8574P - 0x20, а у PCF8574AP - 0x38. Сделано это для того, чтобы к
одной шине можно было подключить до 16-ти расширителей с разными
адресами - максимум 8 штук PCF8574 и 8 штук PCF8574A.

**Технические характеристики:**
-   Рабочий режим питания - от 2.5 до 6 В
-   Низкий ток покоя - максимум 10 мА
-   I^2^C-шина для расширителя параллельного порта
-   Выход прерывания с открытым стоком
-   Дистанционный 8-битный расширитель ввода - вывода I^2^C-шины
-   Адресация на 3 вывода аппаратных адресов для использования до 8
    устройств (до 16 устройств при использовании PCF8574A)

В данной работе каждый расширитель портов закреплен за своим парковочным
местом. Они используются для считывания данных с сенсоров и для вывода
информации о состоянии парковочного места. Был выбран расширитель портов
PCF8574, представленный в форм-факторе PCF8574P и PCF8574АP.

#### Сравнение сенсоров присутствия автомобиля

Ниже в таблице Таблица 5 приведено сравнение сенсоров присутствия автомобиля:

Таблица 5 - Сравнение сенсоров присутствия автомобиля

Свойство                                               | HC-SR04           | E18-D80NK            | US-015            | JSN-SR04T
------------------------------------------------------ | ----------------- | -------------------- | ----------------- | -----------------
Тип                                                    | Ультразвук-овой   | Фотоэлектр-ический   | Ультразвук-овой   | Ультразвук-овой
Обнаружение прозрачных объектов                        | +                 | -                    | +                 | +
Невосприимчивость к бликам                             | +                 | -                    | +                 | +
Работоспособность в условиях недостаточной видимости   | +                 | -                    | +                 | +
Дальность обнаружения                                  | 500 см            | 80 см                | 700 см            | 450 см
Нижний порог обнаружения                               | 3 см              | 3 см                 | 2 см              | 25 см
Цена                                                   | 90 руб            | 280 руб              | 160 руб           | 730 руб

В результате проведенного сравнения (Таблица 5) В качестве сенсора,
следящего за состоянием парковочного места, был выбран ультразвуковой
датчик расстояния HC-SR04, т.к. данный ультразвуковой датчик имеет
следующие преимущества:
-   обнаружение прозрачных объектов;
-   невосприимчивость к световым вспышкам и бликам;
-   работоспособность в сложных условиях (туман, пыль, пар);
-   низкая цена.

#### Ультразвуковой датчик расстояния HC-SR04

Бесконтактный направленный датчик HC-SR04, используя
ультразвуковые волны, измеряет расстояние до объекта. На плате модуля
размещены пьезоизлучатель ультразвука и воспринимающий отраженную волну
микрофон. В отличие от инфракрасных дальномеров на ультразвуковой датчик
HC-SR04 не влияют источники света или цвет препятствия. 
Внешний вид данного датчика показан на рисунке 15.

![Внешний вид ультразвукового датчика расстояния HC-SR04 http://edusnab.ru/upload/iblock/d09/d09faf9a969df7717f0798c8ba945372.jpg](/docs/media/image16.jpeg)

Рисунок 15 - Внешний вид ультразвукового датчика расстояния HC-SR04

Ниже в таблице Таблица 6 приводится описание выводов данного датчика.

Таблица 6 - Описание выводов ультразвукового датчика расстояния HC-SR04

  № Вывода   | Мнемоника   | Описание
  ---------- | ----------- | --------------------------------------------------------------------------------------------------------------------------------------------
  1          | VCC         | Питание +5В
  2          | GND         | Земля
  3          | Trig        | Цифровой вход для включения измерения
  4          | Echo        | Цифровой выход. После завершения измерения, на этот выход будет подана логическая единица на время, пропорциональное расстоянию до объекта

Технические характеристики:
-   Напряжение питания 5 В
-   Ток потребления в режимах
-   ожидания до 2 мА
-   работы 15 мА
-   Частота ультразвука 40 кГц
-   Угол обзора 15 градусов
-   Измеряемое расстояние
-   от 0,03 до 0,6 м с разрешающей способностью 3 мм
-   от 0,6 до 5 м погрешность увеличивается

**Принцип работы:**
1.  Подается импульс продолжительностью 10 мкс, на вывод `Trig`.
2.  Внутри дальномера входной импульс преобразуется в 8 импульсов
    частотой 40 КГц и посылается вперед через \"T глазик\"
3.  Дойдя до препятствия, посланные импульсы отражаются и принимаются
    \"R глазиком\" (Рисунок 17). Получаем выходной сигнал на выводе `Echo`.
4.  Непосредственно на стороне контроллера переводим полученный сигнал в
    расстояние.

![Принцип работы ультразвукового датчика расстояния HC-SR04](/docs/media/image18.png)

Рисунок 17 - Принцип работы ультразвукового датчика расстояния HC-SR04

#### Часы реального времени DS3231SN

Для постоянного учёта хронометрических данных (дата, время) на
микроконтроллере используются часы реального времени DS3231SN. Внешний
вид модуля часов реального времени представлен на рисунке 18.

![Внешний вид модуля часов реального времени DS3231SN https://media2.24aul.ru/imgs/583aea12231ede39d8a435ef/modul-chasov-realnogo-vremeni-zs042-arduino-rtc-2-8614799.jpg](/docs/media/image19.jpeg)

Рисунок 18 - Внешний вид модуля часов реального времени DS3231SN

В таблице 7 приводится описание выводов часов.

Таблица 7 - Описание выводов часов реального времени DS3231SN

  № Вывода   | Мнемоника   | Описание
  ---------- | ----------- | -------------------------------------------
  1          | 32kHz       | Тактовый вывод с частотой 32кГц
  2          | VCC         | Питание +5В
  3          | SQW         | Программируемый выход Square-Wave сигнала
  4          | RST         | Сброс
  5 - 12     | N.C.        | Не соединения
  13         | GND         | Земля
  14         | V~BAT~      | Питание от батареи 3,3В
  15         | SDA         | Последовательная линия данных
  16         | SCL         | Последовательная линия синхронизации

**Технические характеристики:**
-   Рабочая температура -40°C \~ 85°C
-   Напряжение питания, батареи 2,3 V \~ 5,5 V
-   Напряжение питания 2,3 V \~ 5,5 V
-   Интерфейс подключения I²C

Микросхема DS3231 представляет собой высокоточные часы реального времени
RTC, которая обладает встроенным кварцевым генератором с температурной
компенсацией, благодаря чему уход времени составляет всего ±2 минуты за
год. Дополнительно реализована функция будильника, также имеется выход прерываний.

Микросхема использует интерфейс передачи данных I2C. Адрес микросхемы (7 бит) на шине I2C равен `1101000`.

### Описание принципиальной схемы МКПМ

Были спроектированы принципиальные схемы МКПМ на базе PCF8574P и
PCF8574АP, которые представлены на рисунках Е.8 и Д10 соответственно.
Данные схемы соответственно описывают блоки `PPCM` и `PPCM_A`. 
Данные модули отличаются от друг драга - модификацией расширителя порта PCF8574, на которой они построены.
Модуль PPCM построен на базе расширителя порта PCF8574P, а `PPCM_A` - на
базе PCF8574АP. Функциональная схема данных модулей представлена на
рисунке Е.5 и была описана в п.п. 0. В таблице Таблица 8 приведено
описание выводов МКПМ.

![Принципиальная схема МКПМ](/docs/Приложение%20Е.8.%20Принципиальная%20МКПМ.jpg)

Таблица 8 - Описание выводов модулей PPCM / PPCM_A

  № Вывода   | Мнемоника   | Описание
  ---------- | ----------- | ----------------------------------------------------------------------------------------------------------
  1 - 3      | A0 - A2     | Адресные входы
  4          | SDA         | Последовательная линия данных
  5          | SCL         | Последовательная линия синхронизации
  6          | Trig        | Цифровой вход для включения измерения
  7          | VCC         | Питание +5В
  8          | GND         | Земля
  9          | Free        | Выводит сигнал «Free» логическая «1» означает, что данное парковочное место свободно, а «0» - занято
  10         | Booked      | Выводит сигнал «Booked» логическая «1» означает, что данное парковочное место забронировано, а «0» - нет

За каждым парковочным местом закреплен свой МКПМ, состоящий из
расширителя портов PCF8574 (DD1) и сенсора HC-SR04 (DD2). Расширитель
портов осуществляет связь МК с сенсором и выводит информацию о состоянии
парковочного места. К выводам P1 и P2 расширителя соответственно
подключены светодиоды VD1 и VD2, которые наглядно показывают состояние
данного парковочного места. Данный расширитель портов подключены к МК по
шине I2C. PCF8574 имеет 3 адресных входа, таким образом, можно
подключить до 8 таких устройств, следовательно, МКПРСПМ может
обслуживать до 8 парковочных мест. Модификация PCF8574AP имеет другой
базовый адрес, следовательно, параллельно можно подключить еще 8
устройств PCF8574AP, тогда разрабатываемое устройство сможет обслуживать
до 15 парковочных мест + 1 расширитель для подключения клавиатуры к МК.
В таблице 9 приведено описание ролей выводов расширителя портов PCF8574 (DD2).

Таблица 9 - Роли выводов расширителя портов PCF8574P / PCF8574AP

  Контакт                 | Роль
  ----------------------- | ---------------------------------------------------------------------------------------
  1, 2, 3 - A0, A1, A2    | Адресные входы
  4 - P0                  | Выход на вывод Trig сенсора HC-SR04 для включения измерения
  5 - P1                  | Выводится логическая «1», в случае если парковочное место свободно, иначе - «0»
  6 - P2                  | Выводится логическая «1», в случае если парковочное место забронировано, иначе - «0»
  8 - Vss                 | Земля
  14 - SCL                | Последовательная линия синхронизации
  15 - SDA                | Последовательная линия данных
  16 - Vdd                | Питание +5В

Сенсор HC-SR04 (DD2) осуществляет мониторинг занятости данного
парковочного места. Вход Trig сенсора соединен с выводом P0 расширителя
портов PCF8574 (DD1). Для включения измерения сенсора МК подаёт сигнал
на вывод P0 соответствующего расширителя портов. После завершения
измерения на выходе Echo сенсора HC-SR04 будет подана логическая единица
на время, пропорциональное расстоянию до объекта. Выход Echo сенсора
соединён с МК через вход PD3. В таблице 10 приведено описание
ролей выводов данного сенсора.

Таблица 10 - Роли выводов сенсора HC-SR04

  Контакт     | Роль
  ----------- | -------------------------------------------------------------------------------------------------------------------------
  1 - VCC     | Питание +5В
  2 - GND     | Земля
  3 - Echo    | Цифровой вход для включения измерения.
  4 - Trig    | Цифровой выход, после завершения измерения, будет подана логическая единица на время, пропорциональное расстоянию до ТС

Расширители портов PCF8574 (DD1) выдают очень низкий ток 100 мкА,
поэтому были добавлены MOSFET-транзисторы (VT1, VT2) для усиления
выходных сигналов «Free» и «Booked». В цепь затвора транзисторов были
добавлены подтягивающие резисторы (R3, R5), чтобы гарантированно
удерживать высокий уровень на затворе мосфета при отсутствии сигнала
низкого уровня от расширителя (DD1). Это исключает самопроизвольное
выключение транзистора. В разрыв цепи затвора также установлены
резисторы (R1, R2) номиналом 100 Ом, для предотвращения кратковременных
выбросов тока и защиты вывода PCF8574.

### Описание принципиальной схемы МКПРСПМ

На основе описанной элементной базы была разработана
принципиальная схема МКПРСПМ для 15 парковочных мест, которая доступна
для ознакомления на рисунке Е.13.

![Принципиальная схема МКПРСПМ](/docs/Приложение%20Е.13.%20Принципиальная%20схема%20МКПРСПМ.jpg)

Модуль RFM95W (DD7), осуществляющий передачу и приём данных по сети
LoRa, подключен к МК ATMEGA328P-PU (DD8) шине SPI. В таблице 11
приведено описание подключения модуля RFM95W к МК.

Таблица 11 - Подключение модуля RFM95W к МК ATMEGA328P

  Контакт RFM95W    | Контакт МК         | Роль
  ----------------- | ------------------ | -----------------------------------------------------------------------------------
  1, 8, 10 - GND    | -                  | Земля
  2 - MISO          | 18 - PB4 (MISO)    | Приём данных от модуля на МК
  3 - MOSI          | 17 - PB3 (MOSI)    | Передача данных от МК на модуль
  4 - SCK           | 19 - PB5 (SCK)     | Синхронизация передачи данных
  5 - NSS           | 16 - PB2 (SS)      | Выбор подчиненного устройства
  6 - RESET         | 15 - PB1           | Перезапуск модуля
  9 - ANT           | -                  | Вывод на антенну
  13 - 3,3V         | -                  | Питание +3,3В
  14 - DIO0         | 4 - PD2 (INT0)     | Возникновение прерывание на МК при успешном приёме / передачи пакета по сети LoRa

Микроконтроллер Arduino Uno R3 содержит встроенный драйвер USART-USB,
выполненный на ATMEGA16U2 (DD2), необходимый для передачи и приёма
данных на ПЭВМ по последовательному интерфейсу. Таким образом, с помощью
данного модуля можно, как альтернатива модулю RFM95, осуществлять приём / передачу данных.

Для работы шины I2C необходима внешняя подтяжка к питанию, состоящая из
двух резисторов. В данном проекте такими резисторами являются R14 и R15,
номинал которых равен 4,7КОм.

За каждым парковочным местом закреплен свой модуль МКПМ (DD10 - DD24),
которые разделяются на две модификации PPCM (DD11 - DD17) и PPCM_A
(DD10, DD18 - DD24). Данные модули подключаются к МК по шине I2C. PPCM
отличается от PPCM\_A только базовым адресом: у PPCM - `0x20`, а у
PPCM_A - `0x38`. Таким образом, можно подключить до 15 таких устройств,
что позволит МКПРСПМ обслуживать 15 парковочных мест. В таблице 12 приведено описание подключения модулей МКПМ к МК.

Таблица 12 - Подключение модуля PPCM / PPCM\_A к МК ATMEGA328P

  Контакт МКПМ            | Контакт МК   | Роль
  ----------------------- | ------------ | -----------------------------------------------------------------------------------------------------------
  1, 2, 3 - A0, A1, A2    | -            | Адресные входы
  4 - SDA                 | 27 - PC4     | Последовательная линия данных
  5 - SCL                 | 28 - PC5     | Последовательная линия синхронизации
  6 - Trig                | 5 - PD3      | Цифровой вход для включения измерения
  7 - V~CC\ ~             | -            | Питание +5В
  8 - GND                 | -            | Земля
  9 - Free                | -            | Выводит сигнал «Free» логическая «1» означает, что данное парковочное место свободно, а «0» - занято
  10 - Booked             | -            | Выводит сигнал «Booked» логическая «1» означает, что данное парковочное место забронировано, а «0» - нет

Часы реального времени DS3231SN (DD6), используются для учета
хронометрических параметров. Они подключаются к МК по шине I2C. Чтобы
при отключении питания МКПРСПМ время на часах не сбрасывалось, часы
дополнительно питаются от гальванического элемента G1, напряжение
питания которого равно +3,3В. В таблице 13 описывается подключение часов к МК.

Таблица 13 - Подключение часов реального времени DS3231SN к МК ATMEGA328P

  Контакт DS3231SN   | Контакт МК   | Роль
  ------------------ | ------------ | --------------------------------------
  2 - V~CC~          | -            | Питание +5В
  13 - GND           | -            | Земля
  14 - V~BAT~        | -            | Питание от батареи +3,3В
  15 - SDA           | 27 - PC4     | Последовательная линия данных
  16 - SCL           | 28 - PC5     | Последовательная линия синхронизации

Клавиатура AK-1604-N-WWB (DD5) подключается к МК посредством расширителя
портов PCF8574P (DD4). Строки клавиатуры (ROW0 - ROW3) подключаются к
выводам расширителя P0 - P3, а столбцы (COL0 - COL3) - к выводам P4 - P7. Таким образом, для подключения клавиатуры используются не 8
выводов МК, а 2, т.е. линии шины I2C. В таблице 14 приводится
описание подключения данного расширителя PCF8574P (DD4) к микроконтроллеру.

Таблица 10 - Подключение расширителя портов PCF8574P, отвечающего за клавиатуру, к МК ATMEGA328P

| Контакт PCF8574P               | Контакт МК            | Роль                                       |
|--------------------------------|-----------------------|--------------------------------------------|
| 1, 2, 3 - A0, A1, A2           | -                     | Адресные входы                             |
| 4, 5, 6, 7 - P0, P1, P2, P3    | -                     | Выводы для подключения строк клавиатуры    |
| 8 - Vss                        | -                     | Земля                                      |
| 9, 10, 11, 12 - P4, P5, P6, P7 | -                     | Выводы для подключения столбцов клавиатуры |
| 14 - SCL                       | 28 - PC5              | Последовательная линия синхронизации       |
| 15 - SDA                       | 27 - PC4              | Последовательная линия данных              |
| 7 - VDD                        | -                     | Питание +5В                                |

Дисплей WAVGAT_128x64 (DD9) подключается к МК по шине I2C. Ниже в
таблице приведено описание подключения этого дисплея к МК.

Таблица 11 - Подключение дисплея WAVGAT\_128x64 к МК ATMEGA328P

  Контакт WAVGAT_128x64    | Контакт МК  | Роль
  ------------------------ | ----------- | --------------------------------------
  1 - GND                  | -           | Земля
  2 - V~CC~                | -           | Питание +5В
  3 - SCL                  | 28 - PC5    | Последовательная линия синхронизации
  4 - SDA                  | 27 - PC4    | Последовательная линия данных

В качестве драйвера USB-UART используется микроконтроллер ATMEGA16U2
(DD2), обеспечивающий связь микроконтроллера с USB-портом ПЭВМ. При
подключении к ПК Arduino UNO определяется как виртуальный COM-порт.
Заводская прошивка ATMEGA16U2 использует стандартные драйвера USB-COM - установка внешних драйверов не требуется, 
что делает принцип работы микросхемы удобным в эксплуатации. 
В таблице 12 приведено описание подключения драйвера к МК.

Таблица 12 - Описание выводов ATMEGA16U2

  Контакт ATMEGA16U2   | Мнемоника   | Назначение вывода
  -------------------- | ----------- | --------------------------------------------
  4 - VCC              | -           | Питание +5В
  3 - GND              | -           | Земля
  32 - AVCC            | -           | Питание для всех аналоговых устройств
  8 - PD2              | 2 - PD0     | Приём данных на МК
  8 - PD3              | 3 - PD1     | Передача данных от МК
  30 - D-              | -           | Порт USB с отрицательной обратной связью
  29 - D+              | -           | Порт USB с положительной обратной связью
  28 - UGND            | -           | USB земля
  27 - UCAP            | -           | USB регулятор выходного напряжения питания
  1 - XTAL1            | -           | Подключение внешнего резонатора (вход)
  2 - XTAL2            | -           | Подключение внешнего резонатора (выход)

USB-разъем, помимо предоставления интерфейса для последовательной
передачи данных к ПЭВМ, позволяет использовать компьютер, как источник
питания. Для токовой защиты установлен самовосстанавливающийся
предохранитель MF-MSMF050-2 (F1), защищающий порт USB компьютера от
токов короткого замыкания и сверхтоков. Хотя практически все компьютеры
имеют подобную защиту, тем не менее, данный предохранитель обеспечивает
дополнительный барьер. Предохранитель срабатывает при прохождении тока
более 500 мА через USB порт и размыкает цепь до тех пор, пока нормальные
значения токов не будут восстановлены.


Расчет потребляемой мощности
----------------------------

Суммарная мощность, которую потребляет устройство - есть сумма
мощностей элементов, из которых это устройство состоит. 
Мощность - произведение напряжения питания и тока, который протекает через микросхему.

Для расчета потребляемой мощности используем информацию из документации
используемых микросхем и других элементов. Информация о токах и
соответственно мощности, потребляемых микросхемами, приведена в таблице 17.

Таблица 17 - Расчет мощности компонентов

  **Наименование микросхемы**   | **Ток потребления, мА**   | **Напряжение питания**   | **Потребляемая мощность, мВт**
  ----------------------------- | ------------------------- | ------------------------ | --------------------------------
  **ATMEGA328P**                | 16                        | 5                        | 80
  **ATMEGA16U2**                | 50                        | 5                        | 250
  **LoRa BEE**                  | 10,3                      | 3,3                      | 40
  **PCF8574P**                  | 80                        | 5                        | 400
  **HC-SR04**                   | 15                        | 5                        | 75
  **DS3231SN**                  | 3                         | 5                        | 15
  **WAVGAT\_128x64**            | 16                        | 5                        | 80

Используя информацию из таблицы, рассчитаем суммарную потребляемую
мощность, для МКПРСПМ обслуживающего одно парковочное место:

    P = 80 + 250 + 40 + 400 + 75 + 400 + 15 + 80 = 1340 мВт

Для МКПРСПМ обслуживающего 15 парковочных мест, потребляющая мощность
будет составлять:

    P = 80 + 250 + 40 + ( 400 + 75 )*15 + 400 + 15 + 80 = 8710 мВт

    
Описание разработанного программного обеспечения
------------------------------------------------

### Описание схемы алгоритма

Для реализации указанных в задании функций было разработано программное
обеспечение, обеспечивающее взаимодействие элементов микроконтроллерной
системы и обработку поступающих данных.

Схема алгоритма основной программы представлена на рисунке 21.
Первоначально выполняется настройка и инициализация всех используемых
элементов, после чего программа переходит в бесконечный цикл опроса.

![Схема алгоритма основной программы](/docs/Main_algorithm.svg)

Рисунок 21 - Схема алгоритма основной программы

Блок «Обработчик входящих сообщений» является составным для компактности
основной блок схемы. Блок схема этой процедуры представлена на рисунке 22.

![Схема алгоритма процедуры «Обработчик входящих сообщений»](/docs/msgs_hadler_algorithm.svg)

Рисунок 22 - Схема алгоритма процедуры «Обработчик входящих сообщений»

Ниже на рисунке 23 представлена блок схема процедуры «Обработчик платёжного терминала».

![Схема алгоритма процедуры «Обработчик платёжного терминала»](/docs/payment_algorithm.svg)

Рисунок 23 - Схема алгоритма процедуры «Обработчик платёжного терминала»

### Описание диаграммы классов

При разработке программы применялся преимущественно объектный подход,
так как данный подход является наиболее удобным для дальнейшей
разработки и поддержки проекта. На рисунке Е.14 представлена диаграмма
классов разработанной программы. Как можно видеть из диаграммы классов
было реализовано два паттерна «Стратегия» и один «Одиночка».

![Диаграмма классов](/docs/Приложение%20Е.14.%20Диаграмма%20классов%20МКПРСПМ.svg)

Паттерн «Стратегия» позволяет выбирать алгоритм путём определения
соответствующего класса. Класс `ReceiverTransmitter` является
интерфейсом для классов `RadioModule` и `SerialModule`. Это позволило в
основной программе реализовать процедуру выбора драйвера для приёма и
передачи данных. В случае отсутствия радиомодуля LoRa, то в качестве
драйвера будет выбран драйвер USB-UART.

При создании объекта класса `ReceiverTransmitter` в конструктор
передаётся обработчик входящих сообщений - объект, принадлежащий
абстрактному классу `AbstractReceiveMessageHandler`. Это позволяет
задавать различные обработчики входящих сообщений. Например, операция по
изменению ID устройства является небезопасной, и было принято решение
запретить выполнять данную операцию при приёме сообщений по беспроводной
связи, однако при подключении по UART интерфейсу операция разрешена.

Паттерн «Одиночка» - шаблон проектирования, гарантирующий, что в
однопроцессном приложении будет единственный экземпляр некоторого
класса, и предоставляющий глобальную точку доступа к этому экземпляру.
«Одиночкой» является класс `Parameters`, который содержит в себе
настроечные параметры, и осуществляющий запись параметров память EEPROM.
Определив этот класс «Одиночкой», позволило иметь доступ к единственному
экземпляру данного класса из любого места программы.


Описание системы сообщений МКПРСПМ
----------------------------------

Реализована система сообщений для приёма и передачи информации между
МКПРСПМ и вычислительным хабом. Каждое принимаемое и отправляемое
сообщение состоит из заголовка и тела сообщения.

Структура заголовка:
1.  1 байт - Тип сообщения
2.  4 байта - Идентификатор МКПРСПМ

Далее рассматривается структура тела сообщения для каждого типа
сообщений, отправляемых с МКПРСПМ
-   Инициализация МКПРСПМ:
    1.  2 байта - Период опроса датчиков
    2.  2 байта - Период отправки сообщений о состоянии парковочного места
    3.  2 байта - Дневной тариф
    4.  2 байта - Ночной тариф
    5.  4 байта - Время начала дневного тарифа
    6.  4 байта - Время начала ночного тарифа
    
    * **Пакет:**  
        ```
        uint8_t type | uint32_t ID | uint16_t samplingPeriod | uint16_t sendingPeriod | uint16_t dayCost | uint16_t nightCost | uint32_t dayStartTime | uint32_t nightStartTime
        \x49\x00\x00\x00\x01\x00\xFF\x10\x00\x00\xFF\x00\xFF\x00\x00\x00\xFF\x00\x00\x00\xFF
        ```
    * **UART пакет:**
        ```
        uint8_t len | uint8_t type | uint32_t ID | uint16_t samplingPeriod | uint16_t sendingPeriod | uint16_t dayCost | uint16_t nightCost | uint32_t dayStartTime | uint32_t nightStartTime
        \x15\x49\x00\x00\x00\x01\x00\xFF\x10\x00\x00\xFF\x00\xFF\x00\x00\x00\xFF\x00\x00\x00\xFF
        ```

-   Состояние парковочного места:
    1.  1 байт - Идентификатор парковочного места
    2.  1 байт - Булевое значение свободно ли парковочное место

    * **Пакет:**  
        ```
        uint8_t type | uint32_t ID | uint8_t placeId | uint8_t free  
        \x53\x00\x00\x00\x01\x01\x01
        ```
    * **UART пакет:**  
        ```
        uint8_t len | uint8_t type | uint32_t ID | uint8_t placeId | uint8_t free
        \x07\x53\x00\x00\x00\x01\x01\x01
        ```

-   Оплата парковочного места:
    1.  1 байт - Идентификатор парковочного места
    3.  4 байта - Время бронирования
    4.  2 байта - Внесенная сумма
    5.  2 байта - Итоговая стоимость
    
    * **Пакет:**  
        ```
        uint8_t type | uint32_t ID | uint8_t placeId | uint32_t time | uint16_t payment | uint16_t totalCost
        \x50\x00\x00\x00\x01\x01\x00\x00\x00\xFF\x00\xFF\x00\xFF
        ```
    * **UART пакет:**  
        ```
        uint8_t len | uint8_t type | uint32_t ID | uint8_t placeId | uint32_t time | uint16_t payment | uint16_t totalCost
        \x0E\x50\x00\x00\x00\x01\x01\x00\x00\x00\xFF\x00\xFF\x00\xFF
        ```

Структура тела сообщения для основных типов принимаемых сообщений:

-   Изменить идентификатор МКПРСПМ.
    1.  4 байта - Новый идентификатор МКПРСПМ
    
    * **Пакет:**  
        ```
        uint32_t ID | uint8_t type | uint32_t newID`  
        \x00\x00\x00\x01\x69\x00\x00\x00\x02`
        ```
    * **UART пакет:**  
        ```
        uint8_t len | uint32_t ID | uint8_t type | uint32_t newID`  
        \x09\x00\x00\x00\x01\x69\x00\x00\x00\x02`
        ```
    
-   Изменить период опроса сенсоров
    * **Пакет:**  
        ```
        uint32_t ID | uint8_t type | uint16_t period
        \x00\x00\x00\x01\x73\x00\x64
        ```
    * **UART пакет:**  
        ```
        uint8_t len | uint32_t ID | uint8_t type | uint16_t
        \x07\x00\x00\x00\x01\x73\x00\x64
        ```

-   Изменить период отправки сообщений о состоянии парковочного места:
    1.  2 байт - Период отправки сообщений о состоянии парковочного места
    * **Пакет:**
        ```
        uint32_t ID | uint8_t type | uint16_t period 
        \x00\x00\x00\x01\x70\x03\x00
        ```
    * **UART пакет:**  
        ```
        uint8_t len | uint32_t ID | uint8_t type | uint16_t period
        \x07\x00\x00\x00\x01\x70\x03\x00
        ```

-   Изменить время на часах реального времени:
    1.  4 байта - Время

-   Изменить дневной тариф
    1.  2 байта - Стоимость 1 часа в рублях
    
    * **Пакет:**  
        ```
        uint32_t ID | uint8_t type | uint16_t cost
        \x00\x00\x00\x01\x71\x01\x00
        ```
    * **UART пакет:**
        ```
        uint8_t len | uint32_t ID | uint8_t type | uint16_t cost
        \x07\x00\x00\x00\x01\x71\x01\x00
        ```

- Изменить ночной тариф
    * **Пакет:**  
        ```
        uint32_t ID | uint8_t type | uint16_t cost
        \x00\x00\x00\x01\x77\x01\x00
        ```
    * **UART пакет:**  
        ```
        uint8_t len | uint32_t ID | uint8_t type | uint16_t cost
        \x07\x00\x00\x00\x01\x77\x01\x00
        ```
        
-   Изменить параметры настройки
    1.  2 байта - Период опроса датчиков
    2.  2 байта - Период отправки сообщений о состоянии парковочного места
    3.  2 байта - Дневной тариф
    4.  2 байта - Ночной тариф
    5.  4 байта - Время начала дневного тарифа
    6.  4 байта - Время начала ночного тарифа
    
    * **Пакет:**  
        ```
        uint8_t type | uint32_t ID | uint16_t samplingPeriod | uint16_t sendingPeriod | uint16_t dayCost | uint16_t nightCost | uint32_t dayStartTime | uint32_t nightStartTime
        \x73\x00\x00\x00\x01\x00\xFF\x10\x00\x00\xFF\x00\xFF\x00\x00\x00\xFF\x00\x00\x00\xFF
        ```
    * **UART пакет:**  
        ```
        uint8_t len | uint8_t type | uint32_t ID | uint16_t samplingPeriod | uint16_t sendingPeriod | uint16_t dayCost | uint16_t nightCost | uint32_t dayStartTime | uint32_t nightStartTime
        \x15\x73\x00\x00\x00\x01\x00\xFF\x10\x00\x00\xFF\x00\xFF\x00\x00\x00\xFF\x00\x00\x00\xFF
        ```

-   Бронирование парковочного места
    1.  1 байт - Идентификатор парковочного места
    2.  2 байта - Время бронирования
    
    * **Пакет:**  
        ```
        uint32_t ID | uint8_t type | uint8_t placeId | uint32_t period 
        \x72\x00\x00\x00\x01\x01\x00\x00\x00\x14
        ```
    * **UART пакет:**  
        ```
        uint8_t len | uint32_t ID | uint8_t type | uint8_t placeId | uint32_t period
        \x08\x72\x00\x00\x00\x01\x01\x00\x00\x00\x14
        ```

-   Отмена бронирования парковочного места
    1.  1 байт - Идентификатор парковочного места
    
    * **Пакет:**  
        ```
        uint32_t ID | uint8_t type | uint8_t placeId
        \x00\x00\x00\x01\x63\x01
        ```
    * **UART пакет:**  
        ```
        uint8_t len | uint32_t ID | uint8_t type | uint8_t placeId
        \x06\x00\x00\x00\x01\x63\x01
        ```

При отправке сообщения через UART интерфейс перед заголовком добавляется
еще 1 байт - длина сообщения.



Тестирование СМПМ
=================

Для проверки требований, предъявленных в техническом задании, в
разработанной системе мониторинга парковочных мест были протестированы
все компоненты системы, а также было проведено комплексное тестирование
системы (Приложение В). Для тестирования МКПРСПМ был собран отладочный
макет, внешний вид которого изображен на рисунке 30.

![](/docs/media/image32.png)

Рисунок 30 - Внешний вид отладочного макета

Также для проверки и анализа данных работоспособности при большой
нагрузки было проведено нагрузочное тестирование. Так, например, RPS для
выдачи парковочных мест (п.п. 5.4) при заполненной БД (13582 записи)
составила 846 запросов в секунду (более подробнее см. в Приложение В).

Для обеспечения качества в ходе дальнейшей разработки для веб-приложения
были написаны 60 автоматизированных теста, покрывающие весь функционал.
Из них 14 модульных теста, 6 интеграционных теста и 40 функциональных
тестов контроллеров.

Результатом проведенного тестирования было установлено, что были
выполнены все предъявляемые требования к разработанному прототипу
системы мониторинга парковочных мест.


ЗАКЛЮЧЕНИЕ
==========

В результате выполнения выпускной квалификационной работы бакалавра был
спроектирован и реализован аппаратно-программный прототип «Системы
мониторинга парковочных мест». Такая система для водителей будет в
режиме реального времени предоставлять актуальные данные о состоянии
парковочных мест. Данная система состоит из МК-подсистемы регистрации
свободных парковочных мест, вычислительного хаба и центрального сервера.

Программное обеспечение для компонентов системы написано преимущественно
в объектном стиле, который обеспечивает интеграцию и удобство для
дальнейшей разработки командой разработчиков.

В ходе выполнения работы было проведено исследование IoTтехнологий в
транспортной инфраструктуре, а также анализ существующих систем.
Разработанная система экономически более выгодна относительно
конкурентных систем.

Все компоненты системы были отлажены и протестированы. Для
разработанного серверного ПО были написаны автоматизированные тесты для
обеспечения качества в ходе дальнейшей разработки. Также был проведен
анализ безопасности системы. Таким образом, разработанная система
соответствует всем требованиям, заявленных в техническом задании.
